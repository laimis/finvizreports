<!DOCTYPE html>
<html>

<head>
    <title>Dashboard</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.3/css/bulma.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation"></script>

    <script>
        function renderChart(canvasId, labels, datasets)
        {    
            var transactions = [
                { price: 25.21, volume: 80, date: '2022-05-12', type: 'buy' },
                { price: 27.37, volume: 25, date: '2022-05-13', type: 'sell' },
                { price: 28.99, volume: 27, date: '2022-05-16', type: 'sell' },
                { price: 34.01, volume: 28, date: '2022-06-23', type: 'sell' }
            ]

            // map data to annotation format
            const annotations = transactions.map(function(d) {
                return {
                    type: 'point',
                    xValue: d.date,
                    yValue: d.price,
                    backgroundColor: d.type === 'buy' ? "#0000FF" : '#ff0000',
                    radius: 5
                }
            })

            const options = {
                plugins: {
                    autocolors: false,
                    annotation: {
                        annotations: annotations,
                        radius: 2
                    }
                },
                scales: {
                    y: {
                        type: 'logarithmic',
                    }
                }
            };

            const config = {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: datasets
                },
                options
            };

            const ctx = document.getElementById(canvasId).getContext('2d');
            const mychart = new Chart(ctx, config);
        }

        function calculateSMA(interval, data)
        {
            return data.map((item, i) => {
                if (i < interval)
                    return null;

                var sliceOfInterest = data.slice(i - interval, i).map(m => m.close);
                var sum = sliceOfInterest.reduce((a, b) => a + b);
                return sum / interval;
            })
        }

        function calculateEMA(interval, data)
        {
            var multiplier = 2 / (interval + 1);
            var ema = [];
            for (i=0; i<data.length-1; i++)
            {
                if (i <= interval)
                {
                    ema.push(data[i]);
                    continue;
                }

                var prevEma = ema[i-1];
                var currVal = data[i];
                var newEma = currVal * multiplier + prevEma*(1-multiplier);
                ema.push(newEma);
            }
            
            return ema;
        }

        function createChart(canvasId)
        {
            fetch('./stng_2y_closeonly.json')
                .then(response => response.json())
                .then(data => {
                    
                    // take only last 100 closes
                    var labels = data.slice(-100).map(item => item.date)
                    var closes = data.slice(-100).map(item => item.close)
                    
                    // var volume = data.slice(-100).map(item => item.volume)

                    // simple moving average of 150 days closes
                    var sma150 = calculateSMA(150, data).slice(-100);
                    var sma50 = calculateSMA(50, data).slice(-100);
                    var sma20 = calculateSMA(20, data);

                    var ema20 = calculateEMA(20, sma20).slice(-100);

                    var datasets = [
                        {
                            label: 'STNG',
                            data: closes,
                            borderColor: 'rgb(75, 192, 192)',
                            tension: 0.1,
                            pointStyle: 'line'
                        },
                        {
                            label: '150 SMA',
                            data: sma150,
                            tension: 0.1,
                            borderColor: "#3260a8",
                            pointStyle: 'line',
                            borderWidth: 0.5
                        },
                        {
                            label: '50 SMA',
                            data: sma50,
                            tension: 0.1,
                            borderColor: "#32a84a",
                            pointStyle: 'line',
                            borderWidth: 0.5
                        },
                        {
                            label: '20 EMA',
                            data: sma20.slice(-100),
                            tension: 0.1,
                            borderColor: "#ff0000",
                            pointStyle: 'line',
                            borderWidth: 0.5
                        }
                    
                    ]
                    
                    renderChart(canvasId, labels, datasets)
                })
        }
    </script>
    <meta name="viewport" content="width=device-width, initial-scale=1">
</head>

<body>
    <div>
        <canvas id="mychart" aria-label="Chart for 20 EMA Trend" role="img">
            <p>Chart for 20 EMA Trend</p>
        </canvas>
        <script>
            createChart('mychart');
        </script>
    </div>
    <script>

    </script>
</body>

</html>